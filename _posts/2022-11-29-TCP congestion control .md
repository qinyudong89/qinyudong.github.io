---
title: "TCP 拥塞控制"
date: 2022-11-29T00:20:30-04:00
categories:
  - blog
tags:
  - TCP
---

### 前言

TCP 被设计为互联网中主要的可靠传输协议。虽然其最初的设计包含了流量控制功能，够在接收方无法跟上时降低发送方的速度，但是最初并没有提供方法来防止发送方淹没双方之间的网络。为了应该这个问题，拥塞控制就应运而生。

### 拥塞控制

拥塞控制是接收双方通过特定的算法，用于防止网络因为大规模通信负载而瘫痪。其基本方法是当有理由认为网络即将进入拥塞状态（或者已经由于拥塞而出现路由器丢包情况）时减缓 TCP 传输。TCP 拥塞控制的两个核心算法是：**慢启动和拥塞避免。这两个算法是基于包守恒和 ACK 时钟原理。**

> 拥塞控制有 4 个阶段：慢启动、拥塞避免、快速重传、快速恢复，共同构成了拥塞控制算法。

#### 慢启动

在 TCP 刚建立连接的时，由于未知网络的传输能力，为了避免发送的报文超过网络负载。TCP 只能先调低*发送窗口*，减少飞行中的报文数量。这就是 **慢启动** 的由来。

让发送速度变慢是通过引入**拥塞窗口**（全称为 congestion window，缩写为 cwnd，类似地，接收窗口叫做 rwnd，发送窗口叫做 swnd）实现的，它用于避免网络出现拥塞。如果不考虑网络拥塞，发送窗口就等于对方的接收窗口，而考虑了网络拥塞后，发送窗口则应当是拥塞窗口与对方接收窗口的最小值：

```
swnd = min(cwnd, rwnd)
```

这样，发送速度就综合考虑了接收方和网络的处理能力。

##### 触发慢启动的场景：

- 一个新 TCP 连接刚建立时
- 检测到由于重传超时（RTO）导致的丢包时。

##### 触发慢启动结束的场景：

1. 通过定时器明确探测到了丢包；
2. 拥塞窗口的增长到达了慢启动阈值 ssthresh（全称为 slow start threshold），也就是之前发现网络拥塞时的窗口大小；
3. 接收到重复的 ACK 报文，可能存在丢包。



#### 拥塞避免

在慢启动阶段，cwnd 会指数级增长，并确立一个慢启动阈值。一是达到慢启支阈值，就意味着接下来网络拥塞概率会很高，所以进入**拥塞避免阶段**，此时拥塞窗口不能再以指数方式增长，而是要以线性方式增长。接下来，拥塞窗口会以每个 RTT 增加 1 个 MSS 的方式，代替慢启动阶段每收到 1 个 ACK 就增加 1 个 MSS 的方式。

#### 快速重传

*快速重传* 基于接收端的反馈信息来引发重传，而非重传计时器的超时。因此，相较于 *超时重传* ，更能及时有效的修复丢包情况。

当连续收到 3 个重复 ACK 时，发送方便得到了网络发生拥塞的明确信号。通过重复 ACK 报文的序号，我们知道丢失了哪个报文。这样，不等待定时器的触发，立刻重发丢失的报文，可以让发送速度下降得慢一些，这就是 *快速重传*，具体执行过程。

#### 快速恢复

我们知道无论超时还是快速重传，都会进入慢启动阶段。这使得 cwnd 会恢复到初始值 ，直到 cwnd 增长为 ssthresh。对于有较大 BDP 的链路来说，这会使得带宽利用率低下。

*快速恢复* 算法使得 TCP 无须重新慢启动，而只要把传输速率减半即可。

在快速恢复阶段，每收到一个 ACK，cwnd 就能增长 1 SMSS，相应地就意味着能发送一个新的数据包。因此，拥塞窗口会在一段时间内*急速增长*，直到接收到一个好的 ACK。不重复的（好的 ACK）ACK 表明 TCP 结束恢复阶段，拥塞已减少到之前状态。



### 基于测量的拥塞控制算法

上文介绍的是传统拥塞控制算法，它是以丢包作为判断拥塞的依据。然而，网络刚出现拥塞时并不会丢包，而真的出现丢包时，拥塞已经非常严重了。如下图所示，像路由器这样的网络设备，都会有缓冲队列应对突发的、超越处理能力的流量：

![img](https://static001.geekbang.org/resource/image/47/85/4732f8f97aefcb26334f4e7d1d096185.png?wh=957*532)

业界有一种以测量带宽、时延来确定拥塞的方法，在丢包率较高的网络中应用效果尤其好。2016 年 Google 推出的 BBR 算法（全称 Bottleneck Bandwidth and Round-trip propagation time），就是测量驱动的拥塞控制算法，它在 YouTube 站点上应用后使得网络时延下降了 20% 以上，传输带宽也有 5% 左右的提升。

[BBR 拥塞控制算法](https://www.taohui.tech/2019/08/07/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/%E4%B8%80%E6%96%87%E8%A7%A3%E9%87%8A%E6%B8%85%E6%A5%9Agoogle-bbr%E6%8B%A5%E5%A1%9E%E6%8E%A7%E5%88%B6%E7%AE%97%E6%B3%95%E5%8E%9F%E7%90%86/)

### 参考

1. https://developer.mozilla.org/zh-CN/docs/Glossary/TCP_slow_start
2. https://en.wikipedia.org/wiki/Bandwidth-delay_product
3. TCP/IP 详解 卷1 第 16 章 TCP 拥塞控制